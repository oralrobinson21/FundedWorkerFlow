<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CityTasks Admin Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #1a1a1a; }
    .login-container { max-width: 400px; margin: 100px auto; padding: 40px; background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); }
    .dashboard-container { display: none; }
    h1 { font-size: 24px; margin-bottom: 8px; color: #1a1a1a; }
    h2 { font-size: 20px; margin-bottom: 16px; color: #1a1a1a; }
    h3 { font-size: 16px; margin-bottom: 12px; color: #666; }
    .subtitle { color: #666; margin-bottom: 24px; }
    input { width: 100%; padding: 14px 16px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 16px; }
    input:focus { outline: none; border-color: #5B6EFF; }
    button { width: 100%; padding: 14px; background: #5B6EFF; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    button:hover { background: #4a5de0; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .error { color: #dc3545; margin-bottom: 16px; padding: 12px; background: #fff5f5; border-radius: 8px; display: none; }
    .success { color: #28a745; margin-bottom: 16px; padding: 12px; background: #f5fff5; border-radius: 8px; display: none; }
    .header { background: linear-gradient(135deg, #5B6EFF, #4a5de0); color: white; padding: 20px 32px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { color: white; margin: 0; }
    .logout-btn { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 6px; font-size: 14px; width: auto; }
    .logout-btn:hover { background: rgba(255,255,255,0.3); }
    .content { padding: 32px; max-width: 1400px; margin: 0 auto; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .stat-value { font-size: 32px; font-weight: 700; color: #5B6EFF; }
    .stat-label { color: #666; margin-top: 4px; }
    .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 24px; overflow: hidden; }
    .card-header { padding: 20px 24px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .card-body { padding: 24px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #eee; }
    th { font-weight: 600; color: #666; background: #f9f9f9; }
    tr:hover { background: #f9f9f9; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .badge-pending { background: #fff3cd; color: #856404; }
    .badge-active { background: #d4edda; color: #155724; }
    .badge-completed { background: #cce5ff; color: #004085; }
    .badge-cancelled { background: #f8d7da; color: #721c24; }
    .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 24px; }
    .tab { padding: 12px 24px; cursor: pointer; border-bottom: 2px solid transparent; color: #666; }
    .tab.active { border-bottom-color: #5B6EFF; color: #5B6EFF; font-weight: 600; }
    .tab:hover { color: #5B6EFF; }
    .section { display: none; }
    .section.active { display: block; }
    .qr-container { text-align: center; margin: 24px 0; }
    .qr-container img { max-width: 200px; }
    .recovery-codes { background: #f9f9f9; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 14px; }
    .recovery-codes span { display: inline-block; margin: 4px 8px; }
    .search-box { padding: 12px 16px; border: 1px solid #ddd; border-radius: 8px; width: 300px; margin-bottom: 16px; }
    .action-btn { padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: none; margin-right: 4px; }
    .action-btn-view { background: #5B6EFF; color: white; }
    .action-btn-danger { background: #dc3545; color: white; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-content { background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 24px; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; width: auto; padding: 0; }
    .loading { text-align: center; padding: 40px; color: #666; }
  </style>
</head>
<body>
  <div id="loginContainer" class="login-container">
    <div id="loginStep">
      <h1>CityTasks Admin</h1>
      <p class="subtitle">Sign in to the admin dashboard</p>
      <div id="loginError" class="error"></div>
      <input type="email" id="email" placeholder="Admin email" />
      <input type="password" id="password" placeholder="Password" />
      <button id="loginBtn" onclick="login()">Sign In</button>
    </div>
    
    <div id="otpStep" style="display: none;">
      <h1>Two-Factor Authentication</h1>
      <p class="subtitle">Enter the code from your authenticator app</p>
      <div id="otpError" class="error"></div>
      <input type="text" id="otpCode" placeholder="6-digit code" maxlength="6" />
      <button onclick="verifyOtp()">Verify</button>
    </div>
    
    <div id="setupStep" style="display: none;">
      <h1>Admin Setup</h1>
      <p class="subtitle">Create the first admin account</p>
      <div id="setupError" class="error"></div>
      <div id="setupSuccess" class="success"></div>
      <input type="email" id="setupEmail" placeholder="Admin email" />
      <input type="password" id="setupPassword" placeholder="Password (12+ chars, mixed case, number, symbol)" />
      <button onclick="setupAdmin()">Create Admin Account</button>
    </div>
    
    <div id="setup2faStep" style="display: none;">
      <h1>Enable Two-Factor Auth</h1>
      <p class="subtitle">Scan this QR code with your authenticator app</p>
      <div class="qr-container">
        <img id="qrCode" src="" alt="2FA QR Code" />
      </div>
      <p style="color: #666; margin-bottom: 16px;">Secret key: <code id="otpSecret"></code></p>
      <div class="recovery-codes" id="recoveryCodes"></div>
      <p style="color: #dc3545; margin: 16px 0; font-size: 14px;">Save these recovery codes! They won't be shown again.</p>
      <input type="text" id="setup2faCode" placeholder="Enter code from app to verify" maxlength="6" />
      <button onclick="enableOtp()">Enable 2FA & Continue</button>
    </div>
  </div>

  <div id="dashboardContainer" class="dashboard-container">
    <div class="header">
      <h1>CityTasks Admin</h1>
      <div>
        <span id="adminEmail" style="margin-right: 16px;"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    
    <div class="content">
      <div class="tabs">
        <div class="tab active" onclick="showSection('overview')">Overview</div>
        <div class="tab" onclick="showSection('users')">Users</div>
        <div class="tab" onclick="showSection('tasks')">Tasks</div>
        <div class="tab" onclick="showSection('disputes')">Disputes</div>
        <div class="tab" onclick="showSection('logs')">Audit Logs</div>
      </div>
      
      <div id="overview" class="section active">
        <div class="stats-grid" id="statsGrid">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="card">
          <div class="card-header"><h3>Recent Activity</h3></div>
          <div class="card-body">
            <table>
              <thead><tr><th>Event</th><th>User ID</th><th>Task ID</th><th>Time</th></tr></thead>
              <tbody id="activityTable"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div id="users" class="section">
        <input type="text" class="search-box" id="userSearch" placeholder="Search by email, name, or phone..." onkeyup="searchUsers()" />
        <div class="card">
          <div class="card-body">
            <table>
              <thead><tr><th>Email</th><th>Name</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
              <tbody id="usersTable"><tr><td colspan="5" class="loading">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div id="tasks" class="section">
        <select id="taskStatusFilter" class="search-box" style="width: 200px;" onchange="loadTasks()">
          <option value="">All Statuses</option>
          <option value="requested">Requested</option>
          <option value="accepted">Accepted</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <div class="card">
          <div class="card-body">
            <table>
              <thead><tr><th>ID</th><th>Title</th><th>Price</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>
              <tbody id="tasksTable"><tr><td colspan="6" class="loading">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div id="disputes" class="section">
        <div class="card">
          <div class="card-body">
            <table>
              <thead><tr><th>Task</th><th>Initiator</th><th>Reason</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>
              <tbody id="disputesTable"><tr><td colspan="6" class="loading">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div id="logs" class="section">
        <div class="card">
          <div class="card-body">
            <table>
              <thead><tr><th>Admin</th><th>Action</th><th>Resource</th><th>Time</th></tr></thead>
              <tbody id="logsTable"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Details</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/admin';
    let sessionId = localStorage.getItem('adminSession');
    let currentAdminId = null;

    async function checkSetup() {
      try {
        const res = await fetch(`${API_BASE}/setup-status`);
        const data = await res.json();
        if (data.setupRequired) {
          document.getElementById('loginStep').style.display = 'none';
          document.getElementById('setupStep').style.display = 'block';
        }
      } catch (e) {
        console.error('Setup check failed:', e);
      }
    }

    async function setupAdmin() {
      const email = document.getElementById('setupEmail').value;
      const password = document.getElementById('setupPassword').value;
      
      try {
        const res = await fetch(`${API_BASE}/setup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        
        if (!res.ok) {
          document.getElementById('setupError').textContent = data.error;
          document.getElementById('setupError').style.display = 'block';
          return;
        }
        
        currentAdminId = data.adminId;
        document.getElementById('qrCode').src = data.qrCode;
        document.getElementById('otpSecret').textContent = data.otpSecret;
        document.getElementById('recoveryCodes').innerHTML = data.recoveryCodes.map(c => `<span>${c}</span>`).join('');
        
        document.getElementById('setupStep').style.display = 'none';
        document.getElementById('setup2faStep').style.display = 'block';
      } catch (e) {
        document.getElementById('setupError').textContent = 'Network error';
        document.getElementById('setupError').style.display = 'block';
      }
    }

    async function enableOtp() {
      const otpCode = document.getElementById('setup2faCode').value;
      
      try {
        const res = await fetch(`${API_BASE}/enable-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminId: currentAdminId, otpCode })
        });
        const data = await res.json();
        
        if (!res.ok) {
          alert(data.error);
          return;
        }
        
        alert('2FA enabled! Please login with your credentials.');
        location.reload();
      } catch (e) {
        alert('Network error');
      }
    }

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      try {
        const res = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        
        if (!res.ok) {
          document.getElementById('loginError').textContent = data.error;
          document.getElementById('loginError').style.display = 'block';
          return;
        }
        
        sessionId = data.sessionId;
        
        if (data.requiresOtp) {
          document.getElementById('loginStep').style.display = 'none';
          document.getElementById('otpStep').style.display = 'block';
        } else {
          localStorage.setItem('adminSession', sessionId);
          showDashboard(data.admin);
        }
      } catch (e) {
        document.getElementById('loginError').textContent = 'Network error';
        document.getElementById('loginError').style.display = 'block';
      }
    }

    async function verifyOtp() {
      const otpCode = document.getElementById('otpCode').value;
      
      try {
        const res = await fetch(`${API_BASE}/verify-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, otpCode })
        });
        const data = await res.json();
        
        if (!res.ok) {
          document.getElementById('otpError').textContent = data.error;
          document.getElementById('otpError').style.display = 'block';
          return;
        }
        
        localStorage.setItem('adminSession', sessionId);
        showDashboard(data.admin);
      } catch (e) {
        document.getElementById('otpError').textContent = 'Network error';
        document.getElementById('otpError').style.display = 'block';
      }
    }

    function showDashboard(admin) {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('dashboardContainer').style.display = 'block';
      document.getElementById('adminEmail').textContent = admin.email;
      loadDashboard();
    }

    async function logout() {
      try {
        await fetch(`${API_BASE}/logout`, {
          method: 'POST',
          headers: { 'x-admin-session': sessionId }
        });
      } catch (e) {}
      localStorage.removeItem('adminSession');
      location.reload();
    }

    async function loadDashboard() {
      try {
        const res = await fetch(`${API_BASE}/dashboard`, {
          headers: { 'x-admin-session': sessionId }
        });
        
        if (!res.ok) {
          localStorage.removeItem('adminSession');
          location.reload();
          return;
        }
        
        const data = await res.json();
        
        document.getElementById('statsGrid').innerHTML = `
          <div class="stat-card"><div class="stat-value">${data.tasks.total_tasks || 0}</div><div class="stat-label">Total Tasks</div></div>
          <div class="stat-card"><div class="stat-value">${data.tasks.pending_tasks || 0}</div><div class="stat-label">Pending</div></div>
          <div class="stat-card"><div class="stat-value">${data.tasks.active_tasks || 0}</div><div class="stat-label">Active</div></div>
          <div class="stat-card"><div class="stat-value">${data.tasks.completed_tasks || 0}</div><div class="stat-label">Completed</div></div>
          <div class="stat-card"><div class="stat-value">${data.users.total_users || 0}</div><div class="stat-label">Total Users</div></div>
          <div class="stat-card"><div class="stat-value">$${Math.round(data.payments.total_platform_fees || 0)}</div><div class="stat-label">Platform Fees</div></div>
        `;
        
        document.getElementById('activityTable').innerHTML = data.recentActivity.map(a => `
          <tr>
            <td>${a.event_type}</td>
            <td>${a.user_id || '-'}</td>
            <td>${a.task_id || '-'}</td>
            <td>${new Date(a.created_at).toLocaleString()}</td>
          </tr>
        `).join('') || '<tr><td colspan="4">No recent activity</td></tr>';
        
      } catch (e) {
        console.error('Dashboard load error:', e);
      }
    }

    function showSection(section) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(section).classList.add('active');
      event.target.classList.add('active');
      
      if (section === 'users') loadUsers();
      if (section === 'tasks') loadTasks();
      if (section === 'disputes') loadDisputes();
      if (section === 'logs') loadLogs();
    }

    async function loadUsers() {
      const search = document.getElementById('userSearch')?.value || '';
      try {
        const res = await fetch(`${API_BASE}/users?search=${encodeURIComponent(search)}`, {
          headers: { 'x-admin-session': sessionId }
        });
        const data = await res.json();
        
        document.getElementById('usersTable').innerHTML = data.users.map(u => `
          <tr>
            <td>${u.email}</td>
            <td>${u.name || '-'}</td>
            <td><span class="badge ${u.role === 'helper' ? 'badge-active' : 'badge-pending'}">${u.role || 'poster'}</span></td>
            <td>${new Date(u.created_at).toLocaleDateString()}</td>
            <td>
              <button class="action-btn action-btn-view" onclick="viewUser('${u.id}')">View</button>
            </td>
          </tr>
        `).join('') || '<tr><td colspan="5">No users found</td></tr>';
      } catch (e) {
        console.error('Load users error:', e);
      }
    }

    async function loadTasks() {
      const status = document.getElementById('taskStatusFilter')?.value || '';
      try {
        const res = await fetch(`${API_BASE}/tasks?status=${status}`, {
          headers: { 'x-admin-session': sessionId }
        });
        const data = await res.json();
        
        const statusBadge = (status) => ({
          requested: 'badge-pending',
          accepted: 'badge-active',
          completed: 'badge-completed',
          cancelled: 'badge-cancelled'
        }[status] || 'badge-pending');
        
        document.getElementById('tasksTable').innerHTML = data.tasks.map(t => `
          <tr>
            <td>${t.id.slice(0,8)}...</td>
            <td>${t.title}</td>
            <td>$${t.price}</td>
            <td><span class="badge ${statusBadge(t.status)}">${t.status}</span></td>
            <td>${new Date(t.created_at).toLocaleDateString()}</td>
            <td>
              <button class="action-btn action-btn-view" onclick="viewTask('${t.id}')">View</button>
            </td>
          </tr>
        `).join('') || '<tr><td colspan="6">No tasks found</td></tr>';
      } catch (e) {
        console.error('Load tasks error:', e);
      }
    }

    async function loadDisputes() {
      try {
        const res = await fetch(`${API_BASE}/disputes`, {
          headers: { 'x-admin-session': sessionId }
        });
        const data = await res.json();
        
        document.getElementById('disputesTable').innerHTML = data.disputes.map(d => `
          <tr>
            <td>${d.task_title}</td>
            <td>${d.initiator_id}</td>
            <td>${d.reason?.slice(0, 50)}...</td>
            <td><span class="badge badge-pending">${d.status}</span></td>
            <td>${new Date(d.created_at).toLocaleDateString()}</td>
            <td>
              <button class="action-btn action-btn-view" onclick="viewDispute('${d.id}')">View</button>
            </td>
          </tr>
        `).join('') || '<tr><td colspan="6">No disputes found</td></tr>';
      } catch (e) {
        console.error('Load disputes error:', e);
      }
    }

    async function loadLogs() {
      try {
        const res = await fetch(`${API_BASE}/audit-logs`, {
          headers: { 'x-admin-session': sessionId }
        });
        const data = await res.json();
        
        document.getElementById('logsTable').innerHTML = data.logs.map(l => `
          <tr>
            <td>${l.admin_email}</td>
            <td>${l.action}</td>
            <td>${l.resource_type}:${l.resource_id || '-'}</td>
            <td>${new Date(l.created_at).toLocaleString()}</td>
          </tr>
        `).join('') || '<tr><td colspan="4">No logs found</td></tr>';
      } catch (e) {
        console.error('Load logs error:', e);
      }
    }

    function searchUsers() {
      clearTimeout(window.searchTimeout);
      window.searchTimeout = setTimeout(loadUsers, 300);
    }

    async function viewUser(userId) {
      try {
        const res = await fetch(`${API_BASE}/users/${userId}`, {
          headers: { 'x-admin-session': sessionId }
        });
        const data = await res.json();
        
        document.getElementById('modalTitle').textContent = 'User Details';
        document.getElementById('modalBody').innerHTML = `
          <p><strong>ID:</strong> ${data.user.id}</p>
          <p><strong>Email:</strong> ${data.user.email}</p>
          <p><strong>Name:</strong> ${data.user.name || '-'}</p>
          <p><strong>Phone:</strong> ${data.user.phone || '-'}</p>
          <p><strong>Role:</strong> ${data.user.role || 'poster'}</p>
          <p><strong>Created:</strong> ${new Date(data.user.created_at).toLocaleString()}</p>
          <hr style="margin: 16px 0;">
          <p><strong>Tasks:</strong> ${data.tasks.length}</p>
          <p><strong>Offers:</strong> ${data.offers.length}</p>
        `;
        openModal();
      } catch (e) {
        alert('Failed to load user');
      }
    }

    async function viewTask(taskId) {
      try {
        const res = await fetch(`${API_BASE}/tasks/${taskId}`, {
          headers: { 'x-admin-session': sessionId }
        });
        const data = await res.json();
        
        document.getElementById('modalTitle').textContent = 'Task Details';
        document.getElementById('modalBody').innerHTML = `
          <p><strong>ID:</strong> ${data.task.id}</p>
          <p><strong>Title:</strong> ${data.task.title}</p>
          <p><strong>Description:</strong> ${data.task.description || '-'}</p>
          <p><strong>Price:</strong> $${data.task.price}</p>
          <p><strong>Status:</strong> ${data.task.status}</p>
          <p><strong>Poster ID:</strong> ${data.task.poster_id}</p>
          <p><strong>Helper ID:</strong> ${data.task.helper_id || '-'}</p>
          <p><strong>Created:</strong> ${new Date(data.task.created_at).toLocaleString()}</p>
          <hr style="margin: 16px 0;">
          <p><strong>Offers:</strong> ${data.offers.length}</p>
          <p><strong>Chat Messages:</strong> ${data.chatMessages.length}</p>
        `;
        openModal();
      } catch (e) {
        alert('Failed to load task');
      }
    }

    function viewDispute(disputeId) {
      alert('Dispute details view - coming soon');
    }

    function openModal() {
      document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });

    if (sessionId) {
      fetch(`${API_BASE}/dashboard`, { headers: { 'x-admin-session': sessionId } })
        .then(res => {
          if (res.ok) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
            loadDashboard();
          } else {
            localStorage.removeItem('adminSession');
            checkSetup();
          }
        })
        .catch(() => checkSetup());
    } else {
      checkSetup();
    }
  </script>
</body>
</html>
